{% extends "base.html" %}

{% block libs %}
    {{ super() }}

    <script type="text/javascript">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],  // 支持 $...$ 和 \(...\) 语法
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
            },
            options: {
                processEscapes: true  // 允许转义美元符号，例如 \$ 显示为普通的 $
            }
        };
    </script>
    
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    
    <!-- 背景圖片 -->
    <div class="image-background"></div>

    <!-- 星空和流星效果的Canvas背景 -->
    <canvas id="starCanvas" style="z-index: -1; position: fixed; top: 0; left: 0; width: 100%; height: 100%;"></canvas>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        var tocContainer = document.querySelector('.custom-toc-container');
        var contentInner = document.querySelector('.md-content__inner');
        var canvas = document.getElementById('starCanvas');
        var ctx = canvas.getContext('2d');

        // 設置 Canvas 尺寸
        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 星星類別
        class Star {
          constructor() {
            this.reset();  // 隨機初始化星星的位置、大小和透明度
          }

          reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.originalSize = Math.random() * 2 + 1;  // 原始大小
            this.size = 0;  // 初始大小為 0
            this.alpha = 0;  // 初始透明度為 0
            this.growthSpeed = 0.02;  // 增長速度
            this.shrinkSpeed = 0.01;  // 減小速度
            this.life = Math.random() * 200 + 100;  // 星星壽命
          }

          update() {
            // 星星出現時逐漸變大變亮
            if (this.life > 100) {
              this.size += this.growthSpeed;
              this.alpha += this.growthSpeed;
              if (this.size > this.originalSize) {
                this.size = this.originalSize;  // 達到最大值
              }
              if (this.alpha > 1) {
                this.alpha = 1;  // 最大透明度
              }
            } else {
              // 星星消失時逐漸變小變暗
              this.size -= this.shrinkSpeed;
              this.alpha -= this.shrinkSpeed;
              if (this.size < 0) this.size = 0;
              if (this.alpha < 0) this.alpha = 0;
            }

            this.life -= 1;  // 壽命減少
            if (this.life <= 0) {
              this.reset();  // 星星消失後重新生成
            }
          }

          draw() {
            ctx.fillStyle = `rgba(242, 187, 255, ${this.alpha})`;  // 星星顏色
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
          }
        }

        // 流星類別
        class Meteor {
            constructor() {
                this.reset();  // 初始化流星位置、速度等
            }

            reset() {
                // 將 X 坐標範圍擴展，使流星可以在畫布左邊界外開始
                this.x = Math.random() * canvas.width /2;  // 可以從畫布左側邊界外開始
                this.y = Math.random() * canvas.height ;  // 流星從上半部分生成
                this.originalSize = Math.random() * 2 + 2;  // 流星頭部的原始大小
                this.size = 0;  // 初始大小為 0
                this.alpha = 0;  // 初始透明度為 0
                this.growthSpeed = 0.03;  // 流星頭部增長速度
                this.speedX = Math.random() * 8 + 4;
                this.speedY = Math.random() * 4 + 2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                // 流星逐漸變大變亮，隨著運動逐漸消失
                this.size += this.growthSpeed;
                this.alpha += this.growthSpeed;
                if (this.size > this.originalSize) {
                    this.size = this.originalSize;
                }
                if (this.alpha > 1) {
                    this.alpha = 1;
                }
                this.alpha -= 0.025;  // 流星逐漸消失
                if (this.isOutOfView()) {
                    this.reset();  // 流星移出畫布後重置
                }
            }

            draw() {
                // 流星的尾巴
                ctx.strokeStyle = `rgba(242, 187, 255, ${this.alpha})`;
                ctx.lineWidth = this.size;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x - this.speedX * 5, this.y - this.speedY * 5);  // 尾巴
                ctx.stroke();

                // 流星的頭部：星星形狀
                ctx.fillStyle = `rgba(242, 187, 255, ${this.alpha})`;
                this.drawStarShape(this.x, this.y, this.size, 5);  // 繪製流星的頭部為星星
            }

            drawStarShape(cx, cy, spikes, outerRadius, innerRadius) {
                let rot = Math.PI / 2 * 3;
                let step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                for (let i = 0; i < spikes; i++) {
                    let x = cx + Math.cos(rot) * outerRadius;
                    let y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }
                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
                ctx.fill();
            }

            isOutOfView() {
                return this.x > canvas.width || this.y > canvas.height || this.alpha <= 0;
            }
        }




        let starsArray = [];
        let meteorsArray = [];
        const maxMeteors = 10;  // 限制流星總數量

        // 初始化星星
        function initStars() {
          starsArray = [];
          for (let i = 0; i < 150; i++) {  // 增加星星數量
            starsArray.push(new Star());
          }
        }

        // 生成更多流星
        function createMeteor() {
          if (meteorsArray.length < maxMeteors) {  // 確保流星總數量不超過5個
            meteorsArray.push(new Meteor());
          }
        }

        // 更新並繪製星星和流星
        function handleStarsAndMeteors() {
          for (let i = 0; i < starsArray.length; i++) {
            starsArray[i].update();
            starsArray[i].draw();
          }

          for (let i = 0; i < meteorsArray.length; i++) {
            meteorsArray[i].update();
            meteorsArray[i].draw();
            if (meteorsArray[i].isOutOfView()) {
              meteorsArray.splice(i, 1);  // 流星消失後從陣列中移除
              i--;
            }
          }
        }

        // 動畫循環
        function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          handleStarsAndMeteors();
          requestAnimationFrame(animate);
        }

        // 初始化並開始動畫
        initStars();
        animate();

        // 流星的生成頻率增加
        setInterval(createMeteor, 1000);  // 每秒嘗試生成一個流星，且不超過最大數量

        // TOC 相關邏輯
        if (contentInner && tocContainer) {
            // 初始定位 TOC
            updateTocPosition();

            // 添加点击事件以展开/收缩 TOC
            tocContainer.addEventListener('click', function() {
                tocContainer.classList.toggle('expanded');
            });
        }

        function updateTocPosition() {
            var contentInnerRect = contentInner.getBoundingClientRect();
            tocContainer.style.top = contentInnerRect.top + 'px';
            tocContainer.style.left = contentInnerRect.right - 100 + 25 + 'px';
        }

        // 处理图像大小调整的逻辑
        document.querySelectorAll('img').forEach(function(img) {
            const match = img.src.match(/=(\d+)%x$/);
            if (match) {
                const widthPercentage = match[1];
                img.style.width = widthPercentage + '%';
                img.style.height = 'auto';
                img.src = img.src.replace(/=(\d+)%x$/, ''); // 移除 URL 中的自定义语法
            }
        });
      });
    </script>
{% endblock %}

{% block content %}
<div class="md-content__inner">
    {{ super() }}
    <!-- 新增的 TOC 区块，引用 toc 扩展生成的永久链接 -->
    <div class="custom-toc-container">
        <div class="custom-toc-title">目錄</div> <!-- 添加「目錄」标题 -->
        <nav class="custom-toc">
            <ul>
                {% for section in page.toc %}
                <li>
                    <a href="#{{ section.id }}">{{ section.title }}</a>
                    {% if section.children %}
                    <ul>
                        {% for child in section.children %}
                        <li>
                            <a href="#{{ child.id }}">{{ child.title }}</a>
                            {% if child.children %}
                            <ul>
                                {% for grandchild in child.children %}
                                <li>
                                    <a href="#{{ grandchild.id }}">{{ grandchild.title }}</a>
                                    {% if grandchild.children %}
                                    <ul>
                                        {% for greatgrandchild in grandchild.children %}
                                        <li>
                                            <a href="#{{ greatgrandchild.id }}">{{ greatgrandchild.title }}</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </nav>
    </div>
</div>
{% endblock %}
